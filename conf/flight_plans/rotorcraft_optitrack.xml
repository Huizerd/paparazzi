<!DOCTYPE flight_plan SYSTEM "flight_plan.dtd">

<flight_plan alt="1.0" ground_alt="0" lat0="51.990634" lon0="4.376789" max_dist_from_home="8" name="Rotorcraft Optitrack (Delft)" security_height="0.3">
    <header>
        #include "subsystems/datalink/datalink.h"
        #include "subsystems/electrical.h"
        #include "subsystems/radio_control.h"
        #include "subsystems/ahrs.h"
        #include "autopilot.h"
        inline void setNav(void){
        autopilot_mode_auto2 = AP_MODE_NAV;
        autopilot_static_set_mode(AP_MODE_NAV);
        }
        inline void setGuided(void){
        autopilot_mode_auto2 = AP_MODE_GUIDED;
        autopilot_static_set_mode(AP_MODE_GUIDED);
        }
    </header>
    <waypoints>
        <!-- Absolute home to prevent it being moved; equal to lat0, lon0 above -->
        <waypoint lat="51.990634" lon="4.376789" name="HOME"/>
        <!-- x, y are relative to defaults lat0, lon0 above -->
        <!-- alt and height are interchangeable when both setting the reference at startup -->
        <!-- If you don't set alt/height, the default is taken from above -->
        <!-- TODO: Still find a way to set heading for waypoints -->
        <waypoint name="STDBY" x="0.0" y="0.0" alt="1.0"/>
        <waypoint name="STDBY_HIGH" x="0.0" y="0.0" alt="3.5"/>
        <waypoint name="TD" x="0.0" y="0.0" alt="0.0"/>
        <waypoint lat="51.9905874" lon="4.3767766" name="_CZ1"/>
        <waypoint lat="51.990644" lon="4.376721" name="_CZ2"/>
        <waypoint lat="51.990676" lon="4.376805" name="_CZ3"/>
        <waypoint lat="51.9906213" lon="4.3768628" name="_CZ4"/>
        <waypoint lat="51.990595" lon="4.376779" name="_SZ1"/>
        <waypoint lat="51.990640" lon="4.376734" name="_SZ2"/>
        <waypoint lat="51.990667" lon="4.376804" name="_SZ3"/>
        <waypoint lat="51.990623" lon="4.376850" name="_SZ4"/>
    </waypoints>
    <sectors>
        <sector color="red" name="Cyberzoo">
            <corner name="_CZ1"/>
            <corner name="_CZ2"/>
            <corner name="_CZ3"/>
            <corner name="_CZ4"/>
        </sector>
        <sector color="#FF9922" name="SafeZone">
            <corner name="_SZ1"/>
            <corner name="_SZ2"/>
            <corner name="_SZ3"/>
            <corner name="_SZ4"/>
        </sector>
    </sectors>
    <exceptions>
        <!-- Datalink lost (constant RPM descent) -->
        <exception cond="((datalink_time > 5) &&
            !(IndexOfBlock('Holding point') > nav_block) &&
            !(nav_block >= IndexOfBlock('Land here')) &&
            (autopilot_in_flight() == true) )" deroute="Land here"/>
        <!-- OptiTrack lost -->
        <!-- Fail-safe value for thrust, see airframe file -->
        <!-- Geofencing XY -->
        <exception cond="(!InsideSafeZone(GetPosX(), GetPosY()) &&
            !(IndexOfBlock('Holding point') > nav_block) &&
            !(nav_block >= IndexOfBlock('Land here')) &&
            (autopilot_in_flight() == true) )" deroute="Land here"/>
        <!-- Geofencing Z 5.0 -->
        <exception cond="((GetPosAlt() > 5.0) &&
            !(IndexOfBlock('Holding point') > nav_block) &&
            !(nav_block >= IndexOfBlock('Land here')) &&
            (autopilot_in_flight() == true) )" deroute="Standby"/>
        <!-- Bat low -->
        <exception cond="(electrical.bat_low &&
            !(IndexOfBlock('Holding point') > nav_block) &&
            !(nav_block >= IndexOfBlock('Land here')) &&
            (autopilot_in_flight() == true) )" deroute="Land here"/>
    </exceptions>
    <blocks>
        <block name="Wait GPS">
            <call_once fun="NavKillThrottle()"/>
            <while cond="!GpsFixValid()"/>
        </block>
        <block name="Geo init">
            <while cond="LessThan(NavBlockTime(), 2)"/>
            <call_once fun="NavSetGroundReferenceHere()"/>
            <call_once fun="NavSetAltitudeReferenceHere()"/>
        </block>
        <block name="Holding point">
            <call_once fun="NavKillThrottle()"/>
            <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
        </block>
        <block name="Start engine">
            <call_once fun="NavResurrect()"/>
            <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
            <call_once fun="NavResurrect()"/>
        </block>
        <block name="Takeoff" strip_button="Takeoff" strip_icon="takeoff.png">
            <exception cond="GetPosAlt() > 0.5" deroute="Standby"/>
            <stay climb="nav_climb_vspeed" vmode="climb" wp="HOME"/>
        </block>
        <block name="Standby" strip_button="Standby" strip_icon="home.png">
            <stay wp="STDBY"/>
        </block>
        <block name="Standby high">
            <stay wp="STDBY_HIGH"/>
        </block>
        <block name="Set guided">
            <call_once fun="setGuided()"/>
            <stay wp="STDBY_HIGH"/>
        </block>
        <block name="Set nav">
            <call_once fun="setNav()"/>
            <stay wp="STDBY_HIGH"/>
        </block>
        <block name="Land here" strip_button="Land here" strip_icon="land-right.png">
            <call_once fun="setNav()"/>
            <call_once fun="NavSetWaypointHere(WP_TD)"/>
            <go wp="TD"/>
            <deroute block="Flare"/>
        </block>
        <block name="Land">
            <call_once fun="setNav()"/>
            <go wp="TD"/>
            <deroute block="Flare"/>
        </block>
        <block name="Flare">
            <exception cond="0.1 > GetPosAlt()" deroute="Landed"/>
            <call_once fun="NavStartDetectGround()"/>
            <stay climb="nav_descend_vspeed" vmode="climb" wp="TD"/>
        </block>
        <block name="Landed">
            <call_once fun="NavKillThrottle()"/>
            <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
        </block>
    </blocks>
</flight_plan>
